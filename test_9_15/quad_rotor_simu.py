import torch
from scipy.integrate import ode
import numpy as np
import matplotlib.pyplot as plt
import yaml

class FFNNC(torch.nn.Module):
    def __init__(self,D_in = 6, D_out = 8):
        super(FFNNC, self).__init__()
        self.layer1 = torch.nn.Linear(D_in, 20)
        self.layer2 = torch.nn.Linear(20,20)
        self.layer3 = torch.nn.Linear(20,D_out)

    def forward(self,x):
        x = torch.tanh(self.layer1(x))
        x = torch.tanh(self.layer2(x))
        x = self.layer3(x)
        return x

def func1(t,vars,u):

    u1 = u[0]
    u2 = u[1]
    u3 = u[2]
    bx = u[3] 
    by = u[4]
    bz = u[5]

    vx = vars[3]
    vy = vars[4]
    vz = vars[5]

    dvx = 9.81*np.sin(u1)/np.cos(u1)
    dvy = -9.81*np.sin(u2)/np.cos(u2)
    dvz = u3-9.81
    dx = vx
    dy = vy 
    dz = vz
    dref_x = bx
    dref_y = by
    dref_z = bz
    return [dref_x,dref_y,dref_z,dvx,dvy,dvz,dx,dy,dz]

def runModel(initalCondition,steps,ref_input):
    # f = open(fn)
    # model_yaml = yaml.safe_load(f)
    # bias1 = np.array(model_yaml['offsets'][1])
    # bias2 = np.array(model_yaml['offsets'][2])
    # bias3 = np.array(model_yaml['offsets'][3])
    # weight1 = np.array(model_yaml['weights'][1])
    # weight2 = np.array(model_yaml['weights'][2])
    # weight3 = np.array(model_yaml['weights'][3])

    # weight1= [[-0.49672,0.79194,-0.18703,0.39474,-0.31394,-0.70111],[0.40145,-0.01691,0.29554,-0.4627,0.55949,0.02835],[10.2783,-1.4581,9.2976,5.9696,-0.78994,6.1202],[-5.7813,8.1156,-9.0452,-5.7249,5.4597,-6.1755],[-0.09598,0.30701,-0.47135,1.8066,-2.6565,2.0039],[0.67596,-0.20402,-0.18273,-0.024157,0.43354,-0.14214],[3.9717,8.5982,10.5139,2.4158,6.7366,6.4359],[0.96448,-0.62741,-0.17579,0.85173,0.29111,-0.60795],[-0.84457,0.92998,0.95044,-0.63123,-0.49321,-0.31512],[-0.35574,-0.41157,-0.35936,0.1707,0.38472,-0.47624],[-8.6038,-15.5229,8.1415,-7.3435,-8.6555,4.5209],[-3.5774,3.2802,-1.4132,-2.6523,4.1161,-2.4663],[14.7518,-8.1468,-11.7,8.7379,-3.4882,-8.076],[0.72402,0.42752,0.71562,-0.45354,-0.27482,0.20001],[-0.12232,4.4848,-3.3226,-1.7593,1.5175,-0.91373],[-0.48851,0.58916,-0.49593,0.36491,0.26329,0.019227],[0.60204,0.0031422,0.58867,-0.55306,0.41235,-0.39254],[-0.044276,0.58364,-0.13412,-0.97246,0.22718,0.7193],[-0.73132,0.39153,-0.28498,-0.16655,0.29663,0.3432],[0.8557,0.5557,-0.33945,0.87696,-0.66012,0.26695]]
    # weight2= [[-0.78498,-0.060422,5.9631,-5.76,1.48,0.75407,-2.4601,0.072017,-0.15668,-0.87018,2.1072,-2.422,14.2728,0.16909,2.775,-0.94905,-0.61832,-0.25939,0.94843,-0.014238],[0.24734,0.95897,2.6133,0.88052,-1.0022,-0.49284,5.5849,-0.93567,0.72766,0.74085,1.2771,1.5817,-7.7119,0.37305,0.60158,0.4588,0.58761,-0.75316,-0.75446,-0.49112],[-0.90401,-0.27124,-8.6107,10.9912,-2.072,-0.45238,-1.7522,-0.73617,-0.83675,0.40276,-4.9042,4.9126,-3.4323,-0.86054,0.38614,0.44983,0.31685,0.26904,-0.62486,0.76993],[-0.43075,0.54882,0.41692,-0.78123,0.30358,-0.34328,-0.37659,-0.61317,-0.053776,0.20985,0.19693,-0.88165,-0.92786,0.94217,-0.35887,-0.33922,-0.31132,-0.17216,0.77888,-0.23347],[-0.87793,0.10554,1.2866,1.4778,-0.16998,0.095129,0.18234,-0.30686,-0.74891,0.46475,-3.0356,0.13743,3.1983,0.506,0.88441,0.68699,-0.65146,0.98183,0.16681,-0.40485],[0.40704,0.77826,-2.5072,2.3492,-0.53339,-0.55974,-2.9491,-0.87706,0.54577,-0.49312,-0.79799,1.3648,2.3034,0.62799,-0.49992,-0.14312,0.39222,0.85991,-0.38151,0.43519],[0.33691,-0.29009,-0.261,0.23059,0.019731,0.34286,0.45422,0.15396,0.68284,0.20098,0.66677,-0.15742,-1.1423,0.44959,0.22626,0.72937,0.3378,-0.70153,-0.99847,-0.61826],[-0.24284,-0.50896,-0.69843,-0.71279,0.98692,-0.71441,-0.34838,0.024122,-0.91342,0.62924,-0.43572,-0.61489,-0.39331,-0.83988,-0.14467,0.31413,0.6437,-0.21024,-0.5448,-0.76361],[-0.62361,0.82204,-0.2612,-0.83359,0.66897,-0.8118,0.77965,0.23492,-0.027119,-0.89177,0.76751,0.50585,-0.95725,-0.036607,-0.80112,0.16207,0.25648,-0.076841,-0.70919,0.674],[0.49401,-0.91293,-0.0024058,-1.1205,0.6276,0.74038,0.66573,-0.13529,-0.52118,-0.73898,1.1033,-0.82817,1.1428,-0.10865,-0.54566,-0.59855,0.9126,0.1219,-0.59313,0.48827],[-0.31924,0.90151,0.27048,2.828,0.83555,-0.52626,3.8875,0.6854,0.90495,0.68489,-0.79878,1.7812,-6.653,0.36291,0.38445,0.059093,0.24222,0.56073,0.79265,0.18104],[0.5906,0.11281,-0.045974,-0.61665,-0.92054,-0.22799,-0.061042,-0.091882,0.88779,0.23669,-0.546,0.83521,-0.41325,-0.10253,-0.6123,0.78886,-0.60433,-0.025612,0.74619,-0.51422],[-0.024198,-0.24727,-8.0281,7.9647,-2.1422,0.14308,-9.3877,-0.95355,0.22787,0.062576,-6.7652,1.7249,10.25,0.41236,-0.42123,-0.39001,-0.075894,-0.16001,0.40058,0.24649],[0.051339,0.9901,0.97685,-1.1541,0.33939,0.051604,-0.85738,0.76593,0.94697,-0.50342,-0.02618,0.15147,0.12274,0.37844,-0.048918,0.74189,-0.2225,-0.476,-0.059005,0.27671],[-0.94302,-0.88327,-0.88337,-1.3933,-0.58436,-0.84795,-0.62028,0.20086,-0.31028,-0.40984,-0.9326,-0.44398,-0.55816,0.24246,-0.41577,0.81749,0.082406,0.82161,0.65427,-0.34486],[0.28846,0.033413,-0.18182,-0.96657,0.8745,0.74825,-0.92577,0.64601,0.7957,0.74537,-0.6763,0.64516,0.17574,0.2372,-0.01778,-0.34031,-0.23953,-0.95546,-0.0083472,-0.86502],[-0.29869,-0.93781,-2.3766,0.35503,0.25993,0.90227,1.6759,0.90728,-0.13081,-0.15667,6.9428,2.3479,-9.9099,-0.67701,-0.70445,0.36615,1.0857,0.64224,-0.27302,0.76108],[-0.54159,0.14235,-0.85598,-0.23784,0.079298,0.62501,0.3407,-0.89818,-0.52837,-0.87114,0.20437,-0.35803,-0.38942,0.5216,-0.52984,0.79844,0.037609,-0.62306,-0.44879,-0.080087],[-0.13223,-0.63906,-6.6608,-0.73577,1.7322,-0.4324,-11.33,-0.53766,0.88166,0.79397,18.6279,-0.57779,-3.2732,0.57916,-4.7032,-0.84861,-0.59381,0.37151,0.84948,0.52775],[-0.23507,0.26192,-0.94849,-0.85816,-0.10673,0.055694,0.53558,-0.87331,0.36844,-0.59324,-0.30864,0.44261,-0.5111,0.80821,-0.60282,0.75718,-0.85085,-0.28958,-0.22602,-0.49222]]
    # weight3= [[9.4337,0.42238,-9.5361,0.19764,-1.277,-2.4684,0.18609,0.47922,-0.89381,0.2888,-2.4033,-0.2927,-7.6097,0.62782,0.90017,0.8664,-0.55649,0.28672,0.093791,0.75944],[7.4127,-5.1789,-3.706,0.49331,1.8217,1.4095,0.31479,-0.92479,0.098107,0.1971,-5.2591,-0.49232,5.9742,0.9612,0.53498,-0.64427,-6.666,-0.77751,2.6589,0.26399],[2.0527,4.4649,-3.1657,0.083942,0.099055,-2.5337,-0.16102,0.52945,0.60199,0.59572,3.4112,0.82204,-6.8826,0.95533,-0.36013,0.72013,0.41924,0.51612,-12.96,-0.57874],[0.12911,-1.7163,3.4268,0.40107,2.5958,0.89235,-0.037409,0.036563,0.29917,0.96227,-0.40792,0.45129,6.1181,-0.30099,-0.78448,0.91479,-5.5858,0.70389,-10.6644,-0.30977],[-0.14269,1.6238,-3.5674,0.86112,-2.8057,-0.80436,0.95305,-0.98937,0.86289,0.77478,0.53885,-0.94815,-6.0118,0.086206,-0.67333,0.91894,5.8026,0.6885,10.4818,-0.68016],[-1.8933,-4.2864,2.8326,0.72523,-1.4567,2.3314,-0.19917,-0.4456,-0.85054,1.0675,-2.4711,-0.076957,7.4845,0.25242,0.082307,-0.92427,-0.71306,0.78101,13.0361,-0.1113],[-7.5117,5.4768,3.8819,-0.66512,-1.825,-1.3925,0.69434,0.069664,-0.44639,-0.73751,4.1811,-0.4374,-6.1047,-0.19882,-0.15147,-0.88483,6.8932,-0.23632,-2.6859,-0.83245],[-9.258,0.37586,9.8873,-0.47372,-0.21455,2.0617,0.28417,0.53593,0.83848,-0.61829,1.6468,-0.94207,7.8352,-0.46318,0.68771,-0.98841,0.12348,-0.11239,-0.10758,-0.66936]]
    # bias1= [-0.7505,-0.058824,0.97254,1.7801,-0.21632,-0.69655,-0.045678,-0.013656,-0.062668,-0.14393,0.62351,0.53478,0.30221,-0.28444,0.015847,-0.87052,-0.22909,-0.89401,-0.60101,-0.15449]
    # bias2= [0.16639,0.062643,0.036361,-0.74657,0.089001,-0.56275,-0.74195,0.48341,0.23003,-0.015867,-0.77721,0.35675,0.40443,-0.67025,-1.5834,-0.63003,0.5593,0.96518,0.9766,-0.30526]
    # bias3= [-1.1159,0.24248,0.29941,0.86275,-0.71642,-0.35124,-1.3624,0.60169]

    bias1 = [0.005067077465355396,0.013770184479653835,0.02960527129471302,-0.005076207220554352,0.00986097939312458,-0.004963981453329325,0.005067163147032261,0.022097138687968254,0.005067095160484314,-0.009861057624220848,-0.005051563028246164,-0.013770153746008873,0.009860980324447155,0.009861058555543423,0.013770055025815964,0.005067105405032635,-0.01376994326710701,0.005067072343081236,-0.005067067686468363,-0.013769976794719696]
    bias2 = [-0.009237067773938179,-0.00437132129445672,0.0007612668559886515,0.009431629441678524,-0.04935901612043381,0.00892704352736473,0.00891881249845028,-0.042356036603450775,0.03377627208828926,0.014071502722799778,-0.0018434594385325909,-0.0006053714314475656,-0.0038432874716818333,-0.007012223359197378,-0.0007034881855361164,0.007561248727142811,-0.042776428163051605,0.009373181499540806,0.0031296780798584223,0.008734943345189095]
    bias3 = [-0.8870829939842224,-1.152485728263855,-1.3024290800094604,-1.1338839530944824,-0.12526285648345947,-0.35318782925605774,-0.9353211522102356,-1.0099754333496094]

    weight1 = [[-0.012771551497280598,0.8522672653198242,0.005031325854361057,0.010413140058517456,0.5228086709976196,0.0038109351880848408],
    [0.01777890883386135,0.011899493634700775,-0.8380187153816223,0.010888529941439629,0.011424682103097439,-0.5449933409690857],
    [0.01807912439107895,0.012226282618939877,-0.8379306793212891,0.011077952571213245,0.011494635604321957,-0.5451062917709351],
    [0.01277169119566679,-0.8522672057151794,-0.005030765198171139,-0.010413102805614471,-0.5228087902069092,-0.0038107011932879686],
    [-0.8513970971107483,-0.01639718748629093,-0.015279111452400684,-0.5237646102905273,-0.014861795119941235,-0.008371188305318356],
    [0.012770231813192368,-0.8522675633430481,-0.005036665592342615,-0.010414107702672482,-0.5228080749511719,-0.0038130702450871468],
    [-0.012771555222570896,0.8522672653198242,0.005031300242990255,0.01041315495967865,0.5228086709976196,0.0038109151646494865],
    [-0.8513400554656982,-0.01752384752035141,-0.01597718894481659,-0.5237532258033752,-0.01596754789352417,-0.009223726578056812],
    [-0.012771563604474068,0.8522672057151794,0.005031331907957792,0.010413155891001225,0.5228087902069092,0.0038109072484076023],
    [0.8513972163200378,0.016397155821323395,0.015279067680239677,0.5237646698951721,0.014861810952425003,0.008371211588382721],
    [0.012771359644830227,-0.8522672653198242,-0.005032065790146589,-0.010413287207484245,-0.5228086709976196,-0.003811270697042346],
    [-0.01777891255915165,-0.011899505741894245,0.8380184173583984,-0.010888525284826756,-0.011424724943935871,0.5449937582015991],
    [-0.8513973355293274,-0.016397180035710335,-0.01527908630669117,-0.5237643718719482,-0.014861813746392727,-0.008371248841285706],
    [-0.8513972163200378,-0.01639718748629093,-0.0152790741994977,-0.5237645506858826,-0.01486178208142519,-0.008371269330382347],
    [0.01777891255915165,0.011899520643055439,-0.8380185961723328,0.010888495482504368,0.011424724012613297,-0.54499351978302],
    [-0.012771572917699814,0.8522672653198242,0.005031317938119173,0.010413181968033314,0.5228086709976196,0.003810951951891184],
    [-0.017778869718313217,-0.011899495497345924,0.838018536567688,-0.010888428427278996,-0.011424727737903595,0.54499351978302],
    [-0.012771587818861008,0.8522674441337585,0.005031261593103409,0.010413181968033314,0.5228084325790405,0.0038109596353024244],
    [0.012771571055054665,-0.8522672057151794,-0.00503126997500658,-0.010413173586130142,-0.5228086113929749,-0.0038109286688268185],
    [-0.017778851091861725,-0.011899485252797604,0.838018536567688,-0.010888493619859219,-0.0114247165620327,0.54499351978302]]

    weight2 = [[0.004485692363232374,0.4092908799648285,0.40233033895492554,-0.0044856867752969265,-0.008494298905134201,-0.004485597368329763,0.004485687240958214,-0.008073708973824978,0.004485689103603363,0.008494298905134201,-0.004485669545829296,-0.4092909097671509,-0.00849429052323103,-0.008494291454553604,0.4092908799648285,0.004485682118684053,-0.4092908799648285,0.004485685378313065,-0.004485683515667915,-0.4092908799648285],
    [-0.0012539782328531146,0.011227603070437908,0.010983745567500591,0.0012537383008748293,-0.44823628664016724,0.0012566098012030125,-0.0012539738090708852,-0.4422348737716675,-0.0012539689196273685,0.44823625683784485,0.0012543690390884876,-0.011227612383663654,-0.4482363164424896,-0.4482361674308777,0.011227606795728207,-0.001253972644917667,-0.011227593757212162,-0.001253975322470069,0.001253973226994276,-0.01122759748250246],
    [0.0007343984907492995,-0.011749573983252048,-0.011509227566421032,-0.0007341671735048294,0.44823724031448364,-0.0007370298844762146,0.0007343830075114965,0.4421602189540863,0.0007343870238400996,-0.44823718070983887,-0.0007348008803091943,0.011749575845897198,0.44823724031448364,0.44823721051216125,-0.011749569326639175,0.0007343803299590945,0.011749548837542534,0.0007343843462876976,-0.0007343952311202884,0.011749545112252235],
    [0.0032850054558366537,0.012248189188539982,0.012028064578771591,-0.003285229206085205,-0.4482342302799225,-0.0032824152149260044,0.003285015933215618,-0.44198647141456604,0.0032850138377398252,0.44823431968688965,-0.0032846173271536827,-0.012248193845152855,-0.4482342004776001,-0.4482342600822449,0.01224818080663681,0.0032850129064172506,-0.012248178012669086,0.003285012673586607,-0.003285010578110814,-0.012248177081346512],
    [-0.33326631784439087,0.001286709913983941,0.0012743606930598617,0.33326631784439087,0.008707520551979542,0.3332684338092804,-0.33326634764671326,0.009328183718025684,-0.33326634764671326,-0.008707527071237564,0.33326682448387146,-0.001286706537939608,0.008707529865205288,0.008707528933882713,0.0012867064215242863,-0.33326634764671326,-0.001286699203774333,-0.3332662582397461,0.3332662880420685,-0.0012867129407823086],
    [-0.005634149070829153,-0.40926215052604675,-0.4023561179637909,0.005634183995425701,0.008391384966671467,0.005634055007249117,-0.005634150467813015,0.007969524711370468,-0.005634148605167866,-0.008391385897994041,0.005634150002151728,0.4092622399330139,0.008391381241381168,0.008391374722123146,-0.40926244854927063,-0.0056341588497161865,0.40926244854927063,-0.0056341467425227165,0.005634146276861429,0.409262478351593],
    [-0.006210127845406532,-0.4092416763305664,-0.4023682475090027,0.006210171617567539,0.00855502113699913,0.006210030987858772,-0.006210129242390394,0.008134675212204456,-0.006210132036358118,-0.008555027656257153,0.006210120394825935,0.4092416763305664,0.008555008098483086,0.008555013686418533,-0.4092416763305664,-0.006210125517100096,0.409241646528244,-0.00621012831106782,0.006210136227309704,0.4092416763305664],
    [0.3332020938396454,0.0034835836850106716,0.0034986836835741997,-0.3332015573978424,-0.011808326467871666,-0.3332063853740692,0.3332020342350006,-0.012397287413477898,0.3332020342350006,0.01180832739919424,-0.3332027792930603,-0.0034835890401154757,-0.011808333918452263,-0.01180832739919424,0.0034835883416235447,0.3332020342350006,-0.0034835846163332462,0.3332020342350006,-0.333202064037323,-0.003483586013317108],
    [0.3332599997520447,-0.00046248571015894413,-0.0004488642734941095,-0.3332599699497223,-0.009213998913764954,-0.3332628607749939,0.3332599997520447,-0.009829509072005749,0.3332599997520447,0.009213999845087528,-0.33326059579849243,0.00046249059960246086,-0.009214004501700401,-0.009213997051119804,-0.0004624773282557726,0.3332599997520447,0.0004624743014574051,0.3332599997520447,-0.3332599997520447,0.00046248442959040403],
    [0.005426416639238596,0.012804088182747364,0.012594926171004772,-0.005426647607237101,-0.44819632172584534,-0.005423834081739187,0.005426429677754641,-0.44185635447502136,0.005426422227174044,0.4481962323188782,-0.005426030606031418,-0.012804095633327961,-0.4481962323188782,-0.4481961727142334,0.01280409935861826,0.005426430609077215,-0.012804084457457066,0.00542643154039979,-0.005426420830190182,-0.012804084457457066],
    [-8.470881584798917e-05,-0.01166805811226368,-0.011431642808020115,8.493004861520603e-05,0.44824597239494324,8.206536585930735e-05,-8.470812463201582e-05,0.4421427845954895,-8.470044849673286e-05,-0.4482460021972656,8.428884029854089e-05,0.011668059974908829,0.4482460021972656,0.44824597239494324,-0.011668050661683083,-8.470762259094045e-05,0.011668048799037933,-8.469591557513922e-05,8.470559259876609e-05,0.011668049730360508],
    [0.0007104332908056676,-0.012103226035833359,-0.011863806284964085,-0.0007102005183696747,0.4482336640357971,-0.0007130496669560671,0.0007104334654286504,0.4421180486679077,0.0007104235119186342,-0.44823363423347473,-0.0007108247373253107,0.012103239074349403,0.4482337534427643,0.44823357462882996,-0.012103230692446232,0.0007104267715476453,0.012103220447897911,0.0007104279939085245,-0.0007104240357875824,0.012103220447897911],
    [-0.0008108518086373806,-0.011628665030002594,-0.011395211331546307,0.0008111011702567339,0.4482516348361969,0.0008082437561824918,-0.0008108714246191084,0.44211941957473755,-0.000810873054433614,-0.4482516050338745,0.0008104708977043629,0.011628672480583191,0.4482516050338745,0.4482516348361969,-0.011628661304712296,-0.0008108695619739592,0.011628646403551102,-0.0008108615875244141,0.0008108713664114475,0.011628646403551102],
    [0.0052762399427592754,0.4092657268047333,0.4023624062538147,-0.005276260897517204,-0.008586729876697063,-0.0052761598490178585,0.005276238080114126,-0.008165040984749794,0.005276246462017298,0.008586726151406765,-0.0052762338891625404,-0.4092656970024109,-0.00858672522008419,-0.008586717769503593,0.4092656970024109,0.005276253912597895,-0.40926575660705566,0.005276249721646309,-0.005276253912597895,-0.4092658758163452],
    [0.0004666325112339109,-0.01200425997376442,-0.011765711009502411,-0.00046640209620818496,0.44823700189590454,-0.00046925980132073164,0.00046662817476317286,0.4421238601207733,0.0004666206077672541,-0.448236882686615,-0.00046703135012649,0.012004264630377293,0.44823694229125977,0.4482368230819702,-0.01200425811111927,0.0004666294262278825,0.012004253454506397,0.0004666416789405048,-0.00046663961256854236,0.012004251591861248],
    [-0.006058018188923597,-0.40924715995788574,-0.4023823142051697,0.006058032624423504,0.008350761607289314,0.006057909224182367,-0.006058020517230034,0.007928609848022461,-0.00605802284553647,-0.00835077092051506,0.006058006081730127,0.40924718976020813,0.00835077092051506,0.00835077092051506,-0.40924715995788574,-0.006058022379875183,0.4092472195625305,-0.006058013532310724,0.0060580214485526085,0.40924715995788574],
    [0.3332037329673767,0.0033146513160318136,0.003330634441226721,-0.33320334553718567,-0.011781765148043633,-0.3332081437110901,0.33320361375808716,-0.012370237149298191,0.3332037031650543,0.011781767010688782,-0.33320438861846924,-0.0033146499190479517,-0.011781766079366207,-0.011781767010688782,0.003314657835289836,0.3332037329673767,-0.0033146559726446867,0.33320367336273193,-0.3332037329673767,-0.0033146515488624573],
    [-0.005700466223061085,-0.4092574417591095,-0.40236255526542664,0.005700497422367334,0.008488606661558151,0.005700360052287579,-0.005700466688722372,0.008067479357123375,-0.00570047739893198,-0.008488614112138748,0.005700456909835339,0.4092574417591095,0.008488607592880726,0.008488602004945278,-0.4092575013637543,-0.005700466223061085,0.4092575013637543,-0.005700462963432074,0.005700469017028809,0.4092574715614319],
    [0.0007849707617424428,0.012151014059782028,0.011918344534933567,-0.0007852140697650611,-0.4482424557209015,-0.000782380870077759,0.0007849783287383616,-0.4420732855796814,0.0007849846151657403,0.4482424259185791,-0.0007845927611924708,-0.012151009403169155,-0.4482423961162567,-0.4482423961162567,0.012150995433330536,0.0007849778048694134,-0.012150992639362812,0.0007849839166738093,-0.0007849822868593037,-0.012150988914072514],
    [-0.005965784657746553,-0.40925177931785583,-0.4023708701133728,0.005965803749859333,0.008349047973752022,0.005965673830360174,-0.005965787451714277,0.0079267006367445,-0.005965782329440117,-0.008349056355655193,0.0059657711535692215,0.4092518091201782,0.008349052630364895,0.008349040523171425,-0.4092518091201782,-0.00596578698605299,0.40925195813179016,-0.00596578698605299,0.005965790245682001,0.4092518985271454]]

    weight3 = [[-335.4917907714844,295.4498596191406,-300.9907531738281,292.68359375,439.89520263671875,340.9864807128906,341.3768615722656,-446.5185852050781,-442.7583312988281,283.7157287597656,-300.0808410644531,-300.40203857421875,-298.2679748535156,-338.4247741699219,-298.95599365234375,342.16082763671875,-442.63568115234375,340.7982482910156,291.43646240234375,340.5745544433594],
    [333.4602355957031,283.6884460449219,-290.77532958984375,284.6348571777344,458.39697265625,-331.57843017578125,-330.1046142578125,-458.7938232421875,-459.3420104980469,277.3214416503906,-290.0921936035156,-291.56329345703125,-287.3941955566406,332.5392150878906,-289.87408447265625,-327.3385009765625,-456.78961181640625,-331.62420654296875,282.5384521484375,-330.56890869140625],
    [-337.1375427246094,289.10272216796875,-294.45098876953125,296.2870788574219,-438.8525085449219,339.5340881347656,337.7414855957031,435.8607177734375,437.567138671875,293.1355895996094,-295.7801208496094,-293.8027038574219,-295.40887451171875,-337.87371826171875,-293.3611755371094,339.5439147949219,437.2536315917969,338.9185791015625,289.39752197265625,338.4055480957031],
    [331.2817687988281,278.56243896484375,-286.8565979003906,290.38287353515625,-383.39654541015625,-332.671630859375,-332.4136047363281,458.2372741699219,394.3974609375,288.79791259765625,-287.97247314453125,-287.65728759765625,-287.8821105957031,333.19647216796875,-286.55657958984375,-330.1717834472656,458.9079895019531,-332.5555114746094,282.8378601074219,-332.8061828613281],
    [-327.96527099609375,-282.6752014160156,281.63214111328125,-289.4588928222656,376.37738037109375,333.9535217285156,335.0184020996094,-457.1034851074219,-390.4696960449219,-294.4223327636719,281.4463806152344,281.6940002441406,284.7673645019531,-332.4997253417969,284.1268615722656,335.67401123046875,-454.1480407714844,334.2760009765625,-288.58868408203125,333.94891357421875],
    [341.65960693359375,-295.7402648925781,292.73046875,-298.5085754394531,437.5282287597656,-340.9335021972656,-338.32208251953125,-443.3055114746094,-439.6506042480469,-301.7493591308594,292.2878723144531,291.4482116699219,295.3114013671875,341.15484619140625,294.27960205078125,-337.8680419921875,-440.09320068359375,-340.21820068359375,-298.2076721191406,-340.53692626953125],
    [-330.5609130859375,-291.5669860839844,287.8730773925781,-286.07989501953125,-456.10418701171875,332.3810119628906,332.67425537109375,451.7678527832031,455.01104736328125,-287.4740905761719,285.10052490234375,287.6368103027344,286.7076721191406,-332.6780090332031,289.9099426269531,333.3375549316406,453.9902648925781,332.9720764160156,-292.4762878417969,331.2679748535156],
    [340.7230224609375,-301.74951171875,296.9709777832031,-292.6571960449219,-440.14434814453125,-343.39404296875,-343.3323059082031,441.12506103515625,440.0010070800781,-290.7984924316406,294.84613037109375,295.7033996582031,296.45263671875,342.21826171875,298.08880615234375,-341.65997314453125,440.3846130371094,-343.41845703125,-299.17828369140625,-344.0526428222656]]

    bias1 = torch.FloatTensor(bias1)
    bias2 = torch.FloatTensor(bias2)
    bias3 = torch.FloatTensor(bias3)
    weight1 = torch.FloatTensor(weight1)
    weight2 = torch.FloatTensor(weight2)
    weight3 = torch.FloatTensor(weight3)

    controller = FFNNC()
    controller.layer1.weight = torch.nn.Parameter(weight1)
    controller.layer2.weight = torch.nn.Parameter(weight2)
    controller.layer3.weight = torch.nn.Parameter(weight3)
    controller.layer1.bias = torch.nn.Parameter(bias1)
    controller.layer2.bias = torch.nn.Parameter(bias2)
    controller.layer3.bias = torch.nn.Parameter(bias3)        

    control_input_list = [[-0.1,-0.1,7.81],
                     [-0.1,-0.1,11.81],
                     [-0.1,0.1,7.81],
                     [-0.1,0.1,11.81],
                     [0.1,-0.1,7.81],
                     [0.1,-0.1,11.81],
                     [0.1,0.1,7.81],
                     [0.1,0.1,11.81]]
    init = initalCondition
    trajectory = [init]
    r = ode(func1)
    r.set_initial_value(init)
    ex_list = []
    ey_list = []
    ez_list = []
    t = 0
    time = [t]
    trace = [[t]+init]
    for i in range(steps):
        ex = trajectory[i][6] - trajectory[i][0]
        ey = trajectory[i][7] - trajectory[i][1]
        ez = trajectory[i][8] - trajectory[i][2]
        vx = trajectory[i][3]
        vy = trajectory[i][4]
        vz = trajectory[i][5]

        data = torch.FloatTensor([0.2*ex,0.2*ey,0.2*ez,0.1*vx,0.1*vy,0.1*vz])
        res = controller(data)
        res = res.detach().numpy()
        idx = np.argmax(res)
        u = control_input_list[idx] + ref_input
        
        init = trajectory[i]
        r = ode(func1)
        r.set_initial_value(init)
        r.set_f_params(u)
        val = r.integrate(r.t+0.2)

        t += 0.2
        print(i,idx,u,res)
        trajectory.append(list(val))
        time.append(t)
        
        ex_list.append(ex)
        ey_list.append(ey)
        ez_list.append(ez)
        trace.append([t]+list(val))
    return trace

if __name__ == "__main__":
    for i in range(10):
        x_init = np.random.uniform(-0.05,0.05)
        y_init = np.random.uniform(-0.05,0.05)
        init = [0,0,0,0,0,0,x_init,y_init,0]
        trajectory = runModel(init,10,[0.25,-0.25,0])
        trajectory = trajectory+runModel(trajectory[-1][1:10],10,[0.25,0.25,0])
        trajectory = trajectory+runModel(trajectory[-1][1:10],5,[0,0.25,0])
        trajectory = trajectory+runModel(trajectory[-1][1:10],5,[-0.25,0.25,0])

        time = []
        ref_x = []
        ref_y = []
        ref_z = []
        vx = []
        vy = []
        vz = []
        x = []
        y = []
        z = []
        ex_list = []
        ey_list = []
        ez_list = []
        for i in range(len(trajectory)):
            time.append(trajectory[i][0])
            ref_x.append(trajectory[i][1])
            ref_y.append(trajectory[i][2]) 
            ref_z.append(trajectory[i][3]) 
            vx.append(trajectory[i][4]) 
            vy.append(trajectory[i][5]) 
            vz.append(trajectory[i][6]) 
            x.append(trajectory[i][7])
            y.append(trajectory[i][8]) 
            z.append(trajectory[i][9])
            ex_list.append(trajectory[i][7]-trajectory[i][1])
            ey_list.append(trajectory[i][8]-trajectory[i][2])
            ez_list.append(trajectory[i][9]-trajectory[i][3])
        
        plt.figure(1) 
        plt.plot(x,y,'g')
        plt.plot(trajectory[0][7],trajectory[0][8],'r.')
        
        # plt.figure(2)
        # plt.plot(time,vx,'.-')
        
        # plt.figure(3)
        # plt.plot(time,vy,'.-')
        
        # plt.figure(4)
        # plt.plot(ex_list)
        # plt.plot(ey_list)
        # plt.plot(ez_list)
        # plt.legend(['ex','ey','ez'])
    plt.plot
    plt.plot(ref_x,ref_y,'.-')
    plt.plot([-0.05,0.05,0.05,-0.05,-0.05],[-0.05,-0.05,0.05,0.05,-0.05])
    plt.show()